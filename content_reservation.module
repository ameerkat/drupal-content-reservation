<?php
/**
 * Implementation of hook_perm()
 */
function content_reservation_perm(){
	return array('view reservations', 'make reservations', 'modify reservations', 'administer reservation');
}

/**
 * Implementation of hook_theme()
 */
function content_reservation_theme() {
	return array(
		'content_reservation_list' => array(
			'template' => 'content_reservation_list',
			'arguments' => array('content_list' => NULL),
		),
		'content_reservation_fullcalendar_js' => array(
			'template' => 'content_reservation_fullcalendar_js',
			'arguments' => array('event_list' => NULL),
		),
	);
}

/**
 * Helper function that gets human readable node type name from machine readable name
 */
function get_readable_content_type($machine_type_name){
	$result = db_query("SELECT * FROM {node_type} WHERE type = '%s'",  $machine_type_name);
	$row = db_fetch_object($result);
	if($row){
		return $row->name;
	} else {
		return NULL;
	}
}

function generate_fullcalendar_js($even_json){
	
}

/**
 * Reservable content list page callback
 */
function content_reservation_reserve($content_type = NULL, $content_id = NULL){
	if($content_type && !$content_id){
		// There is no content id passed in so we just display the default
		// content reservation list
		global $base_url;
		$content_list = array();
		$result = db_query("SELECT * FROM {node} WHERE type = '%s'",  $content_type);
		while ($row = db_fetch_object($result)) {
			$row->reservation_url = $base_url."/reservations/r/".$content_type."/".$row->nid;
			$content_list[] = $row;
		}
		if(!empty($content_list)){
			$content_name = get_readable_content_type($content_type);
			if($content_name){
				drupal_set_title("Available ".$content_name." Reservations");
			}
			$event_list_json = content_reservation_json("type", $content_type);
			drupal_add_css(drupal_get_path('module', 'content_reservation') .'/content-reservation.css');
			drupal_add_js(drupal_get_path('module', 'content_reservation') .'/lib/fullcalendar/jquery/jquery-1.5.min.js');
			drupal_add_css(drupal_get_path('module', 'content_reservation') .'/lib/fullcalendar/fullcalendar/fullcalendar.css');
			//drupal_add_css(drupal_get_path('module', 'content_reservation') .'/lib/fullcalendar/fullcalendar/fullcalendar.print.css');
			drupal_add_js(drupal_get_path('module', 'content_reservation') .'/lib/fullcalendar/fullcalendar/fullcalendar.js');
			drupal_add_js(theme("content_reservation_fullcalendar_js", $event_list_json), 'inline');
			return theme("content_reservation_list", $content_list);
		} else {
			return "No content found for this content type";
		}
	} elseif ($content_type && $content_id) {
		// TODO Check to see if the actual content_id exists + Print out name
		drupal_add_css(drupal_get_path('module', 'content_reservation') .'/content-reservation.css');
		return drupal_get_form('content_reservation_reservation_form', $content_id);
	} else {
		return "No content type specified";
	}
}

/**
 * Implementation of the reservation form
 */
function content_reservation_reservation_form($form_state, $content_id){
	$form['div_tag'] = array(
		'#type' => 'markup',
		'#value' => '<div class="reservation_form">');
	$form['start'] = array(
		'#type' => 'date_select',
		'#title' => t('From'),
		'#date_format' => 'm/d/Y - H:i',
		'#date_year_range' => '0:+1',
	);
	$form['end'] = array(
		'#type' => 'date_select',
		'#title' => t('To'),
		'#date_format' => 'm/d/Y - H:i',
		'#date_year_range' => '0:+1',
	);
	$form['description'] = array(
		'#type' => 'textarea',
		'#description' => t('Short description of reservation purpose'));
	$form['node_id'] = array(
		'#type' => 'value',
		'#value' => $content_id);
	$form['submit'] = array(
		'#type' => 'submit',
		'#value' => t('Submit'),
		'#submit' => array('content_reservation_reservation_form_submit'));
	return $form;
}

/**
* Event type definition
*/
class FullcalendarEvent{
	public $id;
	public $title;
	public $start;
	public $end;
	public $url;
	public $color;
	public $textColor;
}

function content_reservation_make_json($result){
	$event_list = Array();
	while ($row = db_fetch_object($result)) {
	// TODO replace this with actual color variable depending on type
		$default_color = "#004f45";
		$default_textColor = "#ffffff";
		$event = new FullcalendarEvent();
		$event->id = $row->rid;
		$event->title = $row->description;
		// Convert times to fullcalendar compatible
		$event->start = $row->start;
		$event->end = $row->end;
		$event->color = $default_color;
		$event->textColor = $default_textColor;
		$event_list[] = $event;
	}
	return json_encode($event_list);
}

/**
 * Returns reservation 'events' from the database
 */
function content_reservation_json($query_type, $query_key){
	// TODO Errors
	if ($query_type == 'type'){
		// TODO Select based on get params
		$result = db_query("SELECT * FROM {content_reservation}, {node} WHERE {node}.nid = {content_reservation}.nid AND {node}.type = '%s'",  $query_key);
		return content_reservation_make_json($result);
	} else if ($query_type == 'nid'){
		$result = db_query("SELECT * FROM {content_reservation} WHERE nid = %d",  $query_key);
		return content_reservation_make_json($result);
	} else if ($query_type == 'uid'){
		$result = db_query("SELECT * FROM {content_reservation} WHERE uid = %d",  $query_key);
		return content_reservation_make_json($result);
	} else {
		return "[]";
	}
}

function content_reservation_json_print($query_type, $query_key){
	print content_reservation_json($query_type, $query_key);
}

/**
 * Implementation of the reservation form submit handler
 */
function content_reservation_reservation_form_submit($form, &$form_state){
	if(isset($form_state['values']['start']) &&
		isset($form_state['values']['end'])){
		// TODO Check for conflicts before inserting
		global $user;
		$start = $form_state['values']['start'];
		$end = $form_state['values']['end'];
		$description = $form_state['values']['description'];
		$nid = $form_state['values']['node_id'];
		$uid = $user->uid;
		db_query("INSERT INTO {content_reservation} (nid, uid, description, start, end, created, modified) VALUES (%d, %d, '%s', '%s', '%s', NOW(), NOW())", $nid, $uid, $description, $start, $end);
		drupal_set_message('Your reservation has been added.');
	}
}

/**
 * Implementation of hook_menu()
 */
function content_reservation_menu() {
	$items = array();
	$items['reservations/r'] = array(
		'title' => 'Reservations',
		'description' => 'Lists reservable content',
		'page callback' => 'content_reservation_reserve',
		'access arguments' => array('view reservation'),
		'type' => MENU_NORMAL_ITEM,
	);
	$items['reservations/j'] = array(
		'title' => 'Reservations JSON',
		'description' => 'Returns reservation information wrapped in json',
		'page callback' => 'content_reservation_json_print',
		'access arguments' => array('view reservation'),
		'type' => MENU_CALLBACK,
	);
	return $items;
}
